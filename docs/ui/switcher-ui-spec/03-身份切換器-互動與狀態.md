# éšæ®µ 3ï¸âƒ£: èº«ä»½åˆ‡æ›å™¨ - äº’å‹•èˆ‡ç‹€æ…‹

## ğŸ¯ ç›®æ¨™

å¯¦ä½œèº«ä»½åˆ‡æ›å™¨çš„äº’å‹•é‚è¼¯:
- è¼‰å…¥æ‰€æœ‰å¯åˆ‡æ›çš„èº«ä»½åˆ—è¡¨
- å¯¦ä½œåˆ‡æ›å¸³è™ŸåŠŸèƒ½
- è™•ç†è¼‰å…¥ç‹€æ…‹
- éŒ¯èª¤è™•ç†èˆ‡æç¤º
- æˆåŠŸå›é¥‹

**é ä¼°æ™‚é–“**: 2-3 å°æ™‚
**ä¾è³´**: éšæ®µ 2 (èº«ä»½åˆ‡æ›å™¨ - åŸºç¤çµ„ä»¶)

---

## ğŸ“ æ­¥é©Ÿ 1: æ“´å±• Store åŠŸèƒ½

### 1.1 æ›´æ–° AccountStore

```typescript
// src/app/application/store/account/account.store.ts (æ–°å¢æ–¹æ³•)
import { MatSnackBar } from '@angular/material/snack-bar';

export const AccountStore = signalStore(
  { providedIn: 'root' },
  
  withState(initialState),
  
  withComputed((store) => ({
    // ... ç¾æœ‰çš„ computed
    
    /**
     * æ‰€æœ‰å¯ç”¨å¸³è™Ÿåˆ—è¡¨
     */
    availableAccounts: computed(() => store.accounts()),
    
    /**
     * æŒ‰é¡å‹åˆ†çµ„çš„å¸³è™Ÿ (å·²åœ¨éšæ®µ 1 å®šç¾©)
     */
    groupedAccounts: computed(() => {
      const accounts = store.accounts();
      
      return {
        user: accounts.filter(a => a.type === AccountType.User),
        organizations: accounts.filter(a => a.type === AccountType.Organization),
        teams: accounts.filter(a => a.type === AccountType.Team),
        partners: accounts.filter(a => a.type === AccountType.Partner)
      };
    })
  })),
  
  withMethods((store) => {
    const accountService = inject(AccountService);
    const snackBar = inject(MatSnackBar);
    
    return {
      // ... ç¾æœ‰æ–¹æ³•
      
      /**
       * è¼‰å…¥æ‰€æœ‰å¯ç”¨å¸³è™Ÿ
       */
      loadAvailableAccounts: rxMethod<string>(
        pipe(
          switchMap((userId) =>
            accountService.getUserAccounts(userId).pipe(
              tap((accounts) => {
                patchState(store, { accounts });
              }),
              catchError((error) => {
                console.error('è¼‰å…¥å¸³è™Ÿåˆ—è¡¨å¤±æ•—:', error);
                return of([]);
              })
            )
          )
        )
      ),
      
      /**
       * åˆ‡æ›å¸³è™Ÿ (å¸¶æœ‰ UI å›é¥‹)
       */
      switchAccountWithFeedback: rxMethod<string>(
        pipe(
          tap(() => {
            patchState(store, { isLoading: true, error: null });
          }),
          switchMap((accountId) =>
            accountService.switchAccount(accountId).pipe(
              tap((account) => {
                patchState(store, {
                  account,
                  isLoading: false,
                  error: null
                });
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                snackBar.open(
                  `å·²åˆ‡æ›è‡³ ${account.name}`,
                  'é—œé–‰',
                  { duration: 3000 }
                );
              }),
              catchError((error) => {
                patchState(store, {
                  isLoading: false,
                  error: error.message
                });
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                snackBar.open(
                  'åˆ‡æ›å¸³è™Ÿå¤±æ•—,è«‹ç¨å¾Œå†è©¦',
                  'é—œé–‰',
                  { duration: 5000 }
                );
                
                return of(null);
              })
            )
          )
        )
      )
    };
  })
);
```

### 1.2 æ›´æ–° State ä»‹é¢ (å·²åœ¨éšæ®µ 1 å®šç¾©)

AccountStore çš„ç‹€æ…‹ä»‹é¢å·²åŒ…å« accounts é™£åˆ—,ç„¡éœ€é¡å¤–æ›´æ–°ã€‚

```typescript
// src/app/application/store/account/account.store.ts
// AccountState ä»‹é¢å·²åŒ…å«:
interface AccountState {
  account: Account | null;
  accounts: Account[];  // æ‰€æœ‰å¯ç”¨å¸³è™Ÿ
  isLoading: boolean;
  error: string | null;
}
```

---

## ğŸ“ æ­¥é©Ÿ 2: æ›´æ–°çµ„ä»¶é‚è¼¯

### 2.1 æ“´å±• AccountSwitcherComponent

```typescript
// src/app/presentation/layouts/header/components/account-switcher/account-switcher.component.ts
import { Component, computed, inject, signal, OnInit } from '@angular/core';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';

@Component({
  selector: 'app-account-switcher',
  standalone: true,
  imports: [
    // ... ç¾æœ‰ imports
    MatSnackBarModule
  ],
  templateUrl: './account-switcher.component.html',
  styleUrl: './account-switcher.component.scss'
})
export class AccountSwitcherComponent implements OnInit {
  protected accountStore = inject(AccountStore);
  protected snackBar = inject(MatSnackBar);
  
  protected isMenuOpen = signal(false);
  protected readonly AccountType = AccountType;
  
  // Computed: åˆ†çµ„å¸³è™Ÿ
  protected groupedAccounts = this.accountStore.groupedAccounts;
  
  // Computed: ç•¶å‰å¸³è™Ÿ ID
  protected currentAccountId = computed(() => {
    return this.globalShell.account()?.id;
  });
  
  ngOnInit(): void {
    // è¼‰å…¥æ‰€æœ‰å¯ç”¨å¸³è™Ÿ
    // TODO: å¾ Auth å–å¾—ç•¶å‰ userId
    const userId = 'current-user-id';
    this.globalShell.loadAvailableAccounts(userId);
  }
  
  /**
   * åˆ‡æ›å¸³è™Ÿ
   */
  onSwitchAccount(accountId: string): void {
    // å¦‚æœæ˜¯ç•¶å‰å¸³è™Ÿ,ä¸åŸ·è¡Œåˆ‡æ›
    if (accountId === this.currentAccountId()) {
      return;
    }
    
    // åŸ·è¡Œåˆ‡æ›
    this.globalShell.switchAccountWithFeedback(accountId);
  }
  
  /**
   * æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰å¸³è™Ÿ
   */
  isCurrentAccount(accountId: string): boolean {
    return accountId === this.currentAccountId();
  }
  
  /**
   * é–‹å•Ÿç®¡ç†å¸³è™Ÿé é¢
   */
  onManageAccounts(): void {
    // TODO: å°èˆªåˆ°ç®¡ç†å¸³è™Ÿé é¢
    console.log('é–‹å•Ÿç®¡ç†å¸³è™Ÿé é¢');
  }
  
  // ... å…¶ä»–ç¾æœ‰æ–¹æ³•
}
```

---

## ğŸ“ æ­¥é©Ÿ 3: æ›´æ–°æ¨¡æ¿

### 3.1 å‹•æ…‹æ¸²æŸ“å¸³è™Ÿåˆ—è¡¨

```html
<!-- account-switcher.component.html (æ›´æ–°) -->

<mat-menu
  #accountMenu="matMenu"
  class="account-menu"
  xPosition="before"
  yPosition="below">
  
  <!-- å€‹äººå¸³è™Ÿ -->
  <div class="menu-section">
    <div class="section-title">å€‹äººå¸³è™Ÿ</div>
    
    @if (groupedAccounts().user.length > 0) {
      @for (account of groupedAccounts().user; track account.id) {
        <button
          mat-menu-item
          class="account-item"
          [class.active]="isCurrentAccount(account.id)"
          (click)="onSwitchAccount(account.id)"
          [disabled]="globalShell.isLoading()">
          
          <div class="account-item-content">
            <div class="item-avatar">
              @if (account.photoURL) {
                <img [src]="account.photoURL" [alt]="account.name">
              } @else {
                <mat-icon>person</mat-icon>
              }
            </div>
            
            <div class="item-info">
              <div class="item-name">{{ account.displayName }}</div>
              <div class="item-meta">User</div>
            </div>
            
            @if (isCurrentAccount(account.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </div>
        </button>
      }
    } @else {
      <div class="empty-state">ç„¡å¯ç”¨å¸³è™Ÿ</div>
    }
  </div>
  
  <mat-divider></mat-divider>
  
  <!-- çµ„ç¹” -->
  <div class="menu-section">
    <div class="section-title">çµ„ç¹”</div>
    
    @if (groupedAccounts().organizations.length > 0) {
      @for (org of groupedAccounts().organizations; track org.id) {
        <button
          mat-menu-item
          class="account-item"
          [class.active]="isCurrentAccount(org.id)"
          (click)="onSwitchAccount(org.id)"
          [disabled]="globalShell.isLoading()">
          
          <div class="account-item-content">
            <div class="item-avatar">
              @if (org.orgLogo) {
                <img [src]="org.orgLogo" [alt]="org.name">
              } @else {
                <mat-icon>business</mat-icon>
              }
            </div>
            
            <div class="item-info">
              <div class="item-name">{{ org.name }}</div>
              <div class="item-meta">
                Organization Â· {{ org.memberCount }} members
              </div>
            </div>
            
            @if (isCurrentAccount(org.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </div>
        </button>
      }
    } @else {
      <div class="empty-state">å°šæœªåŠ å…¥ä»»ä½•çµ„ç¹”</div>
    }
  </div>
  
  <mat-divider></mat-divider>
  
  <!-- åœ˜éšŠ -->
  <div class="menu-section">
    <div class="section-title">åœ˜éšŠ</div>
    
    @if (groupedAccounts().teams.length > 0) {
      @for (team of groupedAccounts().teams; track team.id) {
        <button
          mat-menu-item
          class="account-item"
          [class.active]="isCurrentAccount(team.id)"
          (click)="onSwitchAccount(team.id)"
          [disabled]="globalShell.isLoading()">
          
          <div class="account-item-content">
            <div class="item-avatar">
              <mat-icon>groups</mat-icon>
            </div>
            
            <div class="item-info">
              <div class="item-name">{{ team.name }}</div>
              <div class="item-meta">
                Team Â· {{ team.memberCount }} members
              </div>
            </div>
            
            @if (isCurrentAccount(team.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </div>
        </button>
      }
    } @else {
      <div class="empty-state">å°šæœªåŠ å…¥ä»»ä½•åœ˜éšŠ</div>
    }
  </div>
  
  <mat-divider></mat-divider>
  
  <!-- åˆä½œå¤¥ä¼´ -->
  <div class="menu-section">
    <div class="section-title">åˆä½œå¤¥ä¼´</div>
    
    @if (groupedAccounts().partners.length > 0) {
      @for (partner of groupedAccounts().partners; track partner.id) {
        <button
          mat-menu-item
          class="account-item"
          [class.active]="isCurrentAccount(partner.id)"
          (click)="onSwitchAccount(partner.id)"
          [disabled]="globalShell.isLoading()">
          
          <div class="account-item-content">
            <div class="item-avatar">
              <mat-icon>handshake</mat-icon>
            </div>
            
            <div class="item-info">
              <div class="item-name">{{ partner.companyName }}</div>
              <div class="item-meta">
                Partner Â· {{ partner.partnerLevel }}
              </div>
            </div>
            
            @if (isCurrentAccount(partner.id)) {
              <mat-icon class="check-icon">check</mat-icon>
            }
          </div>
        </button>
      }
    } @else {
      <div class="empty-state">å°šæœªå»ºç«‹åˆä½œå¤¥ä¼´é—œä¿‚</div>
    }
  </div>
  
  <mat-divider></mat-divider>
  
  <!-- ç®¡ç†å¸³è™Ÿ -->
  <button
    mat-menu-item
    class="manage-accounts"
    (click)="onManageAccounts()">
    <mat-icon>settings</mat-icon>
    <span>ç®¡ç†å¸³è™Ÿ...</span>
  </button>
</mat-menu>
```

---

## ğŸ“ æ­¥é©Ÿ 4: è¼‰å…¥ç‹€æ…‹è™•ç†

### 4.1 ç¦ç”¨ç‹€æ…‹æ¨£å¼

```scss
// account-switcher.component.scss (æ–°å¢)

.account-item {
  // ... ç¾æœ‰æ¨£å¼
  
  // ç¦ç”¨ç‹€æ…‹
  &[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
    
    &:hover {
      background: transparent !important;
    }
  }
}

// è¼‰å…¥ä¸­çš„é¸å–®é®ç½© (å¯é¸)
::ng-deep .account-menu {
  &.loading {
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
  }
}
```

---

## ğŸ“ æ­¥é©Ÿ 5: å¿«æ·éµæ”¯æ´

### 5.1 æ–°å¢å¿«æ·éµæœå‹™

```typescript
// src/app/shared/services/keyboard-shortcut.service.ts
import { Injectable, inject } from '@angular/core';
import { fromEvent, filter, map } from 'rxjs';
import { DOCUMENT } from '@angular/common';

export interface KeyboardShortcut {
  key: string;
  ctrl?: boolean;
  shift?: boolean;
  alt?: boolean;
  meta?: boolean;
}

@Injectable({
  providedIn: 'root'
})
export class KeyboardShortcutService {
  private document = inject(DOCUMENT);
  
  /**
   * è¨»å†Šå¿«æ·éµ
   */
  register(shortcut: KeyboardShortcut) {
    return fromEvent<KeyboardEvent>(this.document, 'keydown').pipe(
      filter((event) => this.matchesShortcut(event, shortcut)),
      map((event) => {
        event.preventDefault();
        return event;
      })
    );
  }
  
  private matchesShortcut(
    event: KeyboardEvent,
    shortcut: KeyboardShortcut
  ): boolean {
    const keyMatch = event.key.toLowerCase() === shortcut.key.toLowerCase();
    const ctrlMatch = shortcut.ctrl ? event.ctrlKey || event.metaKey : true;
    const shiftMatch = shortcut.shift ? event.shiftKey : true;
    const altMatch = shortcut.alt ? event.altKey : true;
    
    return keyMatch && ctrlMatch && shiftMatch && altMatch;
  }
}
```

### 5.2 åœ¨çµ„ä»¶ä¸­ä½¿ç”¨å¿«æ·éµ

```typescript
// account-switcher.component.ts (æ–°å¢)
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { KeyboardShortcutService } from '@/shared/services/keyboard-shortcut.service';

export class AccountSwitcherComponent implements OnInit {
  private keyboardShortcut = inject(KeyboardShortcutService);
  private destroyRef = inject(DestroyRef);
  
  ngOnInit(): void {
    // ... ç¾æœ‰åˆå§‹åŒ–
    
    // è¨»å†Š Ctrl+Shift+A å¿«æ·éµ
    this.keyboardShortcut
      .register({ key: 'a', ctrl: true, shift: true })
      .pipe(takeUntilDestroyed(this.destroyRef))
      .subscribe(() => {
        // è§¸ç™¼é¸å–®é–‹å•Ÿ
        // éœ€è¦é€é ViewChild å–å¾— MatMenuTrigger
        this.menuTrigger?.openMenu();
      });
  }
}
```

---

## âœ… é©—è­‰æ¸…å–®

- [ ] é»æ“Šå¸³è™Ÿé …ç›®å¯æˆåŠŸåˆ‡æ›
- [ ] åˆ‡æ›ä¸­é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
- [ ] åˆ‡æ›æˆåŠŸé¡¯ç¤ºæˆåŠŸè¨Šæ¯
- [ ] åˆ‡æ›å¤±æ•—é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- [ ] ç•¶å‰å¸³è™Ÿæœ‰å‹¾é¸æ¨™è¨˜
- [ ] ç©ºç‹€æ…‹æ­£ç¢ºé¡¯ç¤º
- [ ] å¿«æ·éµ Ctrl+Shift+A å¯é–‹å•Ÿé¸å–®
- [ ] åˆ‡æ›å¾Œé¸å–®è‡ªå‹•é—œé–‰

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: MatSnackBar ä¸é¡¯ç¤º?
**A**: ç¢ºèªå·²åœ¨ `app.config.ts` ä¸­æä¾› MatSnackBar

### Q: å¿«æ·éµä¸ç”Ÿæ•ˆ?
**A**: æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å…¨åŸŸå¿«æ·éµè¡çª

---

## â­ï¸ ä¸‹ä¸€æ­¥

å®Œæˆå¾Œç¹¼çºŒ **éšæ®µ 4: å·¥ä½œå€åˆ‡æ›å™¨ - åŸºç¤çµ„ä»¶**
