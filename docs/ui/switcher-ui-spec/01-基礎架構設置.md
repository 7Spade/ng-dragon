# éšæ®µ 1ï¸âƒ£: åŸºç¤æ¶æ§‹è¨­ç½®

## ğŸ¯ ç›®æ¨™

å»ºç«‹åˆ‡æ›å™¨åŠŸèƒ½æ‰€éœ€çš„åŸºç¤æ¶æ§‹,åŒ…æ‹¬:
- é¡å‹å®šç¾© (TypeScript interfaces)
- Store æ¶æ§‹ (NgRx Signals)
- æœå‹™å±¤ (Firebase æ•´åˆ)
- å…±ç”¨å·¥å…·

**é ä¼°æ™‚é–“**: 2-3 å°æ™‚

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ account.model.ts          # èº«ä»½ç›¸é—œé¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace.model.ts        # å·¥ä½œå€ç›¸é—œé¡å‹
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”œâ”€â”€ global-shell.store.ts     # å…¨åŸŸ Shell Store
â”‚   â”‚   â”‚   â”œâ”€â”€ workspace-list.store.ts   # å·¥ä½œå€åˆ—è¡¨ Store
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ account.service.ts        # èº«ä»½æœå‹™
â”‚   â”‚       â”œâ”€â”€ workspace.service.ts      # å·¥ä½œå€æœå‹™
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ constants/
â”‚           â””â”€â”€ breakpoints.ts            # éŸ¿æ‡‰å¼æ–·é»å®šç¾©
```

---

## ğŸ“ æ­¥é©Ÿ 1: å»ºç«‹é¡å‹å®šç¾©

### 1.1 èº«ä»½æ¨¡å‹ (`account.model.ts`)

```typescript
// src/app/core/models/account.model.ts

/**
 * å¸³è™Ÿé¡å‹æšèˆ‰
 */
export enum AccountType {
  User = 'user',
  Organization = 'organization',
  Team = 'team',
  Partner = 'partner'
}

/**
 * å¸³è™Ÿè§’è‰²æšèˆ‰
 */
export enum AccountRole {
  Owner = 'owner',
  Admin = 'admin',
  Member = 'member',
  Collaborator = 'collaborator',
  Viewer = 'viewer'
}

/**
 * åŸºç¤å¸³è™Ÿä»‹é¢
 */
export interface BaseAccount {
  id: string;
  type: AccountType;
  name: string;
  avatar?: string;
  createdAt: Date;
  updatedAt: Date;
}

/**
 * ä½¿ç”¨è€…å¸³è™Ÿ
 */
export interface UserAccount extends BaseAccount {
  type: AccountType.User;
  email: string;
  photoURL?: string;
  displayName: string;
}

/**
 * çµ„ç¹”å¸³è™Ÿ
 */
export interface OrganizationAccount extends BaseAccount {
  type: AccountType.Organization;
  orgLogo?: string;
  domain?: string;
  memberCount: number;
}

/**
 * åœ˜éšŠå¸³è™Ÿ
 */
export interface TeamAccount extends BaseAccount {
  type: AccountType.Team;
  organizationId: string;
  memberCount: number;
}

/**
 * åˆä½œå¤¥ä¼´å¸³è™Ÿ
 */
export interface PartnerAccount extends BaseAccount {
  type: AccountType.Partner;
  companyName: string;
  partnerLevel: 'bronze' | 'silver' | 'gold' | 'platinum';
}

/**
 * è¯åˆå¸³è™Ÿé¡å‹
 */
export type Account = UserAccount | OrganizationAccount | TeamAccount | PartnerAccount;

/**
 * å¸³è™Ÿæˆå“¡é—œä¿‚
 */
export interface AccountMembership {
  accountId: string;
  userId: string;
  role: AccountRole;
  joinedAt: Date;
}

/**
 * ç•¶å‰å¸³è™Ÿç‹€æ…‹
 */
export interface CurrentAccountState {
  account: Account | null;
  membership?: AccountMembership;
  isLoading: boolean;
  error: string | null;
}
```

### 1.2 å·¥ä½œå€æ¨¡å‹ (`workspace.model.ts`)

```typescript
// src/app/core/models/workspace.model.ts

/**
 * å·¥ä½œå€é¡å‹æšèˆ‰
 */
export enum WorkspaceType {
  Project = 'project',
  Department = 'department',
  Client = 'client',
  Campaign = 'campaign',
  Product = 'product',
  Internal = 'internal'
}

/**
 * å·¥ä½œå€ç‹€æ…‹æšèˆ‰
 */
export enum WorkspaceStatus {
  Active = 'active',
  Archived = 'archived',
  Deleted = 'deleted'
}

/**
 * å·¥ä½œå€ä»‹é¢
 */
export interface Workspace {
  id: string;
  name: string;
  description?: string;
  type: WorkspaceType;
  status: WorkspaceStatus;
  
  // è¦–è¦ºè¨­è¨ˆ
  avatar?: string;
  color?: string;
  icon?: string;
  
  // æ‰€æœ‰æ¬Š
  ownerId: string;
  accountId: string; // æ‰€å±¬å¸³è™Ÿ ID
  
  // æˆå“¡çµ±è¨ˆ
  memberCount: number;
  
  // æ™‚é–“æˆ³è¨˜
  createdAt: Date;
  updatedAt: Date;
  lastAccessedAt?: Date;
  archivedAt?: Date;
}

/**
 * å·¥ä½œå€æˆå“¡
 */
export interface WorkspaceMember {
  workspaceId: string;
  userId: string;
  role: 'owner' | 'admin' | 'member' | 'viewer';
  joinedAt: Date;
}

/**
 * å·¥ä½œå€åå¥½è¨­å®š
 */
export interface WorkspacePreferences {
  userId: string;
  workspaceId: string;
  isFavorite: boolean;
  lastAccessed: Date;
  viewOrder?: number;
}

/**
 * å·¥ä½œå€åˆ†çµ„
 */
export interface WorkspaceGroup {
  title: string;
  workspaces: Workspace[];
}

/**
 * å·¥ä½œå€åˆ—è¡¨ç‹€æ…‹
 */
export interface WorkspaceListState {
  workspaces: Workspace[];
  favorites: string[]; // workspace IDs
  recents: string[]; // workspace IDs (æœ€è¿‘ä½¿ç”¨)
  currentWorkspaceId: string | null;
  searchQuery: string;
  isLoading: boolean;
  error: string | null;
}
```

### 1.3 åŒ¯å‡ºæª”æ¡ˆ (`index.ts`)

```typescript
// src/app/core/models/index.ts
export * from './account.model';
export * from './workspace.model';
```

---

## ğŸ“ æ­¥é©Ÿ 2: å»ºç«‹ Store

### 2.1 å…¨åŸŸ Shell Store (`global-shell.store.ts`)

```typescript
// src/app/core/stores/global-shell.store.ts
import { computed, inject } from '@angular/core';
import { signalStore, withState, withComputed, withMethods, patchState } from '@ngrx/signals';
import { rxMethod } from '@ngrx/signals/rxjs-interop';
import { pipe, switchMap, tap, catchError, of } from 'rxjs';

import { AccountService } from '../services/account.service';
import { Account, CurrentAccountState } from '../models';

/**
 * åˆå§‹ç‹€æ…‹
 */
const initialState: CurrentAccountState = {
  account: null,
  membership: undefined,
  isLoading: false,
  error: null
};

/**
 * å…¨åŸŸ Shell Store - ç®¡ç†ç•¶å‰èº«ä»½ç‹€æ…‹
 */
export const GlobalShellStore = signalStore(
  { providedIn: 'root' },
  
  withState(initialState),
  
  withComputed((store) => ({
    /**
     * æ˜¯å¦å·²ç™»å…¥
     */
    isAuthenticated: computed(() => !!store.account()),
    
    /**
     * ç•¶å‰å¸³è™Ÿåç¨±
     */
    accountName: computed(() => {
      const account = store.account();
      return account?.name || '';
    }),
    
    /**
     * ç•¶å‰å¸³è™Ÿé ­åƒ
     */
    accountAvatar: computed(() => {
      const account = store.account();
      if (!account) return undefined;
      
      if ('photoURL' in account) return account.photoURL;
      if ('orgLogo' in account) return account.orgLogo;
      return account.avatar;
    }),
    
    /**
     * ç•¶å‰ç”¨æˆ¶è§’è‰²
     */
    currentRole: computed(() => store.membership()?.role)
  })),
  
  withMethods((store) => {
    const accountService = inject(AccountService);
    
    return {
      /**
       * è¼‰å…¥ç•¶å‰å¸³è™Ÿ
       */
      loadCurrentAccount: rxMethod<string>(
        pipe(
          tap(() => patchState(store, { isLoading: true, error: null })),
          switchMap((accountId) =>
            accountService.getAccount(accountId).pipe(
              tap((account) => {
                patchState(store, {
                  account,
                  isLoading: false,
                  error: null
                });
              }),
              catchError((error) => {
                patchState(store, {
                  isLoading: false,
                  error: error.message
                });
                return of(null);
              })
            )
          )
        )
      ),
      
      /**
       * åˆ‡æ›å¸³è™Ÿ
       */
      switchAccount: rxMethod<string>(
        pipe(
          tap(() => patchState(store, { isLoading: true, error: null })),
          switchMap((accountId) =>
            accountService.switchAccount(accountId).pipe(
              tap((account) => {
                patchState(store, {
                  account,
                  isLoading: false,
                  error: null
                });
              }),
              catchError((error) => {
                patchState(store, {
                  isLoading: false,
                  error: error.message
                });
                return of(null);
              })
            )
          )
        )
      ),
      
      /**
       * é‡ç½®ç‹€æ…‹
       */
      reset: () => {
        patchState(store, initialState);
      }
    };
  })
);
```

### 2.2 å·¥ä½œå€åˆ—è¡¨ Store (`workspace-list.store.ts`)

```typescript
// src/app/core/stores/workspace-list.store.ts
import { computed, inject } from '@angular/core';
import { signalStore, withState, withComputed, withMethods, patchState } from '@ngrx/signals';
import { rxMethod } from '@ngrx/signals/rxjs-interop';
import { pipe, switchMap, tap, catchError, of } from 'rxjs';

import { WorkspaceService } from '../services/workspace.service';
import { Workspace, WorkspaceListState, WorkspaceGroup, WorkspaceStatus } from '../models';

/**
 * åˆå§‹ç‹€æ…‹
 */
const initialState: WorkspaceListState = {
  workspaces: [],
  favorites: [],
  recents: [],
  currentWorkspaceId: null,
  searchQuery: '',
  isLoading: false,
  error: null
};

/**
 * å·¥ä½œå€åˆ—è¡¨ Store
 */
export const WorkspaceListStore = signalStore(
  { providedIn: 'root' },
  
  withState(initialState),
  
  withComputed((store) => ({
    /**
     * ç•¶å‰å·¥ä½œå€
     */
    currentWorkspace: computed(() => {
      const workspaces = store.workspaces();
      const currentId = store.currentWorkspaceId();
      return workspaces.find(w => w.id === currentId) || null;
    }),
    
    /**
     * å·²ç¯©é¸çš„å·¥ä½œå€åˆ—è¡¨
     */
    filteredWorkspaces: computed(() => {
      const workspaces = store.workspaces();
      const query = store.searchQuery().toLowerCase();
      
      if (!query) return workspaces;
      
      return workspaces.filter(w =>
        w.name.toLowerCase().includes(query) ||
        w.description?.toLowerCase().includes(query)
      );
    }),
    
    /**
     * æœ€è¿‘ä½¿ç”¨çš„å·¥ä½œå€
     */
    recentWorkspaces: computed(() => {
      const workspaces = store.workspaces();
      const recentIds = store.recents();
      
      return recentIds
        .map(id => workspaces.find(w => w.id === id))
        .filter((w): w is Workspace => !!w)
        .slice(0, 5); // åªé¡¯ç¤ºæœ€è¿‘ 5 å€‹
    }),
    
    /**
     * æˆ‘çš„æœ€æ„›å·¥ä½œå€
     */
    favoriteWorkspaces: computed(() => {
      const workspaces = store.workspaces();
      const favoriteIds = store.favorites();
      
      return workspaces.filter(w => favoriteIds.includes(w.id));
    }),
    
    /**
     * å·²å°å­˜çš„å·¥ä½œå€
     */
    archivedWorkspaces: computed(() => {
      return store.workspaces().filter(w => w.status === WorkspaceStatus.Archived);
    }),
    
    /**
     * æ´»èºçš„å·¥ä½œå€
     */
    activeWorkspaces: computed(() => {
      return store.workspaces().filter(w => w.status === WorkspaceStatus.Active);
    }),
    
    /**
     * åˆ†çµ„çš„å·¥ä½œå€
     */
    groupedWorkspaces: computed((): WorkspaceGroup[] => {
      const filtered = store.filteredWorkspaces();
      const favorites = store.favorites();
      const recents = store.recents();
      
      const groups: WorkspaceGroup[] = [];
      
      // æœ€è¿‘ä½¿ç”¨
      const recentWorkspaces = recents
        .map(id => filtered.find(w => w.id === id))
        .filter((w): w is Workspace => !!w && w.status === WorkspaceStatus.Active)
        .slice(0, 5);
      
      if (recentWorkspaces.length > 0) {
        groups.push({
          title: 'æœ€è¿‘ä½¿ç”¨',
          workspaces: recentWorkspaces
        });
      }
      
      // æˆ‘çš„æœ€æ„›
      const favWorkspaces = filtered.filter(w =>
        favorites.includes(w.id) && w.status === WorkspaceStatus.Active
      );
      
      if (favWorkspaces.length > 0) {
        groups.push({
          title: 'æˆ‘çš„æœ€æ„›',
          workspaces: favWorkspaces
        });
      }
      
      // æˆ‘çš„å·¥ä½œå€ (owner)
      const myWorkspaces = filtered.filter(w =>
        w.status === WorkspaceStatus.Active &&
        !favorites.includes(w.id) &&
        !recents.slice(0, 5).includes(w.id)
      );
      
      if (myWorkspaces.length > 0) {
        groups.push({
          title: 'æˆ‘çš„å·¥ä½œå€',
          workspaces: myWorkspaces
        });
      }
      
      return groups;
    })
  })),
  
  withMethods((store) => {
    const workspaceService = inject(WorkspaceService);
    
    return {
      /**
       * è¼‰å…¥å·¥ä½œå€åˆ—è¡¨
       */
      loadWorkspaces: rxMethod<string>(
        pipe(
          tap(() => patchState(store, { isLoading: true, error: null })),
          switchMap((accountId) =>
            workspaceService.getWorkspacesByAccount(accountId).pipe(
              tap((workspaces) => {
                patchState(store, {
                  workspaces,
                  isLoading: false,
                  error: null
                });
              }),
              catchError((error) => {
                patchState(store, {
                  isLoading: false,
                  error: error.message
                });
                return of([]);
              })
            )
          )
        )
      ),
      
      /**
       * è¨­ç½®ç•¶å‰å·¥ä½œå€
       */
      setCurrentWorkspace: (workspaceId: string) => {
        patchState(store, { currentWorkspaceId: workspaceId });
        
        // æ›´æ–°æœ€è¿‘ä½¿ç”¨åˆ—è¡¨
        const recents = store.recents();
        const newRecents = [
          workspaceId,
          ...recents.filter(id => id !== workspaceId)
        ].slice(0, 10); // ä¿ç•™æœ€è¿‘ 10 å€‹
        
        patchState(store, { recents: newRecents });
      },
      
      /**
       * è¨­ç½®æœå°‹é—œéµå­—
       */
      setSearchQuery: (query: string) => {
        patchState(store, { searchQuery: query });
      },
      
      /**
       * åˆ‡æ›æˆ‘çš„æœ€æ„›
       */
      toggleFavorite: (workspaceId: string) => {
        const favorites = store.favorites();
        const newFavorites = favorites.includes(workspaceId)
          ? favorites.filter(id => id !== workspaceId)
          : [...favorites, workspaceId];
        
        patchState(store, { favorites: newFavorites });
      },
      
      /**
       * é‡ç½®ç‹€æ…‹
       */
      reset: () => {
        patchState(store, initialState);
      }
    };
  })
);
```

### 2.3 åŒ¯å‡ºæª”æ¡ˆ (`index.ts`)

```typescript
// src/app/core/stores/index.ts
export * from './global-shell.store';
export * from './workspace-list.store';
```

---

## ğŸ“ æ­¥é©Ÿ 3: å»ºç«‹æœå‹™å±¤

### 3.1 èº«ä»½æœå‹™ (`account.service.ts`)

```typescript
// src/app/core/services/account.service.ts
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, doc, getDoc, getDocs, query, where } from '@angular/fire/firestore';
import { Observable, from, map } from 'rxjs';

import { Account, AccountType, AccountMembership } from '../models';

@Injectable({
  providedIn: 'root'
})
export class AccountService {
  private firestore = inject(Firestore);
  
  /**
   * å–å¾—å–®ä¸€å¸³è™Ÿ
   */
  getAccount(accountId: string): Observable<Account> {
    const accountRef = doc(this.firestore, 'accounts', accountId);
    
    return from(getDoc(accountRef)).pipe(
      map((snapshot) => {
        if (!snapshot.exists()) {
          throw new Error('Account not found');
        }
        
        return {
          id: snapshot.id,
          ...snapshot.data()
        } as Account;
      })
    );
  }
  
  /**
   * å–å¾—ä½¿ç”¨è€…çš„æ‰€æœ‰å¸³è™Ÿ
   */
  getUserAccounts(userId: string): Observable<Account[]> {
    const membershipsRef = collection(this.firestore, 'accountMemberships');
    const q = query(membershipsRef, where('userId', '==', userId));
    
    return from(getDocs(q)).pipe(
      map((snapshot) => {
        const accountIds = snapshot.docs.map(doc => doc.data()['accountId'] as string);
        
        // ä¸¦è¡Œå–å¾—æ‰€æœ‰å¸³è™Ÿè³‡æ–™
        return Promise.all(
          accountIds.map(id => getDoc(doc(this.firestore, 'accounts', id)))
        );
      }),
      map((snapshots) => {
        return snapshots
          .filter(snapshot => snapshot.exists())
          .map(snapshot => ({
            id: snapshot.id,
            ...snapshot.data()
          } as Account));
      })
    );
  }
  
  /**
   * åˆ‡æ›å¸³è™Ÿ
   */
  switchAccount(accountId: string): Observable<Account> {
    // å„²å­˜åˆ° LocalStorage
    localStorage.setItem('currentAccountId', accountId);
    
    return this.getAccount(accountId);
  }
  
  /**
   * å–å¾—ç•¶å‰å¸³è™Ÿ ID
   */
  getCurrentAccountId(): string | null {
    return localStorage.getItem('currentAccountId');
  }
}
```

### 3.2 å·¥ä½œå€æœå‹™ (`workspace.service.ts`)

```typescript
// src/app/core/services/workspace.service.ts
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, query, where, getDocs, orderBy } from '@angular/fire/firestore';
import { Observable, from, map } from 'rxjs';

import { Workspace } from '../models';

@Injectable({
  providedIn: 'root'
})
export class WorkspaceService {
  private firestore = inject(Firestore);
  
  /**
   * å–å¾—å¸³è™Ÿçš„æ‰€æœ‰å·¥ä½œå€
   */
  getWorkspacesByAccount(accountId: string): Observable<Workspace[]> {
    const workspacesRef = collection(this.firestore, 'workspaces');
    const q = query(
      workspacesRef,
      where('accountId', '==', accountId),
      orderBy('lastAccessedAt', 'desc')
    );
    
    return from(getDocs(q)).pipe(
      map((snapshot) => {
        return snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        } as Workspace));
      })
    );
  }
  
  /**
   * æ›´æ–°æœ€å¾Œå­˜å–æ™‚é–“
   */
  updateLastAccessed(workspaceId: string): Observable<void> {
    // å¯¦ä½œæ›´æ–°é‚è¼¯
    return from(Promise.resolve());
  }
}
```

### 3.3 åŒ¯å‡ºæª”æ¡ˆ (`index.ts`)

```typescript
// src/app/core/services/index.ts
export * from './account.service';
export * from './workspace.service';
```

---

## ğŸ“ æ­¥é©Ÿ 4: å»ºç«‹å…±ç”¨å¸¸æ•¸

### 4.1 éŸ¿æ‡‰å¼æ–·é» (`breakpoints.ts`)

```typescript
// src/app/shared/constants/breakpoints.ts

/**
 * éŸ¿æ‡‰å¼æ–·é»å®šç¾©
 */
export const BREAKPOINTS = {
  // è‡ªå®šç¾©æ–·é»
  mobile: '(max-width: 767px)',
  tablet: '(min-width: 768px) and (max-width: 1023px)',
  desktop: '(min-width: 1024px)',
  
  // Material CDK æ–·é»
  xs: '(max-width: 599px)',
  sm: '(min-width: 600px) and (max-width: 959px)',
  md: '(min-width: 960px) and (max-width: 1279px)',
  lg: '(min-width: 1280px) and (max-width: 1919px)',
  xl: '(min-width: 1920px)'
} as const;

/**
 * æ–·é»é¡å‹
 */
export type BreakpointName = keyof typeof BREAKPOINTS;
```

---

## âœ… é©—è­‰æ¸…å–®

å®Œæˆæ­¤éšæ®µå¾Œ,ç¢ºèªä»¥ä¸‹é …ç›®:

- [ ] æ‰€æœ‰é¡å‹å®šç¾©æª”æ¡ˆå·²å»ºç«‹
- [ ] GlobalShellStore å¯æ­£å¸¸ç·¨è­¯
- [ ] WorkspaceListStore å¯æ­£å¸¸ç·¨è­¯
- [ ] AccountService å¯æ­£å¸¸ç·¨è­¯
- [ ] WorkspaceService å¯æ­£å¸¸ç·¨è­¯
- [ ] æ‰€æœ‰æª”æ¡ˆéƒ½æœ‰æ­£ç¢ºçš„åŒ¯å‡º
- [ ] TypeScript ç„¡ç·¨è­¯éŒ¯èª¤
- [ ] ESLint ç„¡è­¦å‘Š

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: NgRx Signals å¥—ä»¶æ‰¾ä¸åˆ°?
**A**: ç¢ºèªå·²å®‰è£ `@ngrx/signals`:
```bash
yarn add @ngrx/signals
```

### Q: Firebase é¡å‹éŒ¯èª¤?
**A**: ç¢ºèªå·²å®‰è£ `@angular/fire`:
```bash
yarn add @angular/fire
```

### Q: computed å‡½æ•¸ç„¡æ³•ä½¿ç”¨?
**A**: ç¢ºèªå·²å¾ `@angular/core` åŒ¯å…¥ `computed`

---

## ğŸ“š ç›¸é—œè³‡æº

- [NgRx Signals å®˜æ–¹æ–‡ä»¶](https://ngrx.io/guide/signals)
- [Angular Fire æ–‡ä»¶](https://github.com/angular/angularfire)
- [TypeScript æ‰‹å†Š](https://www.typescriptlang.org/docs/handbook/intro.html)

---

## â­ï¸ ä¸‹ä¸€æ­¥

å®Œæˆæ­¤éšæ®µå¾Œ,è«‹ç¹¼çºŒ **éšæ®µ 2: èº«ä»½åˆ‡æ›å™¨ - åŸºç¤çµ„ä»¶** (`02-èº«ä»½åˆ‡æ›å™¨-åŸºç¤çµ„ä»¶.md`)
